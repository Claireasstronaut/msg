# 数据 {#chap:data}

```{r,include=FALSE}
library(MSG)
library(ggplot2)
```

> “哦，你还不知道吧？”他笑了，大声说道。“很惭愧，我写了几篇专论，都是技术方面的。比方说，有一篇叫《论各种烟灰的辨别》。此文列举了一百四十种雪茄烟。卷烟、烟斗烟丝的烟灰，并附有彩色插图，以说明烟灰的区别。这是刑事审判中常常出现的重要证据，有时还是案件的重要线索。举例说，如果你断定某一谋杀案系一个抽印度雪茄的男人所为，显然缩小了侦查范围。在训练有素的人看来，印度雪茄的黑灰与‘鸟眼’牌的白灰的区别，正如白菜和土豆的区别一样大。”
> 
> --- 柯南$\cdot$道尔《四签名》  

本章中我们首先从数据的角度对前文中所叙述的统计图形进行简单的梳理与总结，即：什么样的数据适合用什么样的统计图形展示，以及数据中的信息以怎样的方式表达；然后我们以一些实际数据案例来说明统计图形的应用，这些数据都尽量取自生活，以保证足够的新颖性；最后我们也利用统计模拟生成的数据来说明统计图形的另类价值，即它在解释统计模型中的独特地位。

## 数据类型 {#sec:data-type}

我们知道统计数据可以分为离散型和连续型两种。所谓离散数据，又称分类数据（categorical data），就是数据的取值范围只是有限个元素的集合，或者可以一一列举的元素的集合，例如性别、民族、国籍等；所谓连续数据，也就是取值范围为一段连续的区间，例如气温、速度、体重等。如本书最早第\@ref(cha:tools)章所提到的，统计图形要刻画的核心对象是统计分布。对分类数据来说，和分布联系最密切的概念是频数；对连续数据来说，则有很多种可能性，可以是分位数、密度曲线、相关系数等等。下面我们对每种数据类型在不同维度下的图形类型做一个简单概括如表\@ref(tab:plot-summary)，注意该表格并非一个完整的作图指引，面对实际数据时，我们仍然需要具体问题具体分析。

Table: (\#tab:plot-summary) 各种类型的数据对应的统计图形概览

---------- --------------- ---------------- ------------------------ --------
                一维             二维                 高维             矩阵
 分类数据      条形图          马赛克图             马赛克图                  
                            关联图、四瓣图                           
 连续数据      直方图           散点图             平行坐标图         颜色图
               箱线图                        散点图矩阵、三维散点图    热图
            Cleveland点图                    三维透视图、平滑散点图   等高图
             一维散点图                      星状图、符号图、脸谱图  
 混合数据                     条件密度图           条件分割图        
                                棘状图                               
---------- --------------- ---------------- ------------------------ --------	


### 分类数据

对于分类数据，我们关心的往往是每个分类的频数或者比例是多少，这样的问题通常也都很简单，阅读图形仅仅是用眼睛排序的工作。一维分类数据几乎没有别的选择，我们最常用的是条形图（\@ref(sec:barplot)小节）；多维数据情况下，马赛克图（\@ref(sec:mosaicplot)小节）能清晰表达列联表中各个单元格的频数大小，同时也能观察表中的边际概率和条件概率。除了描述性质的图形，我们还可以使用具有推断性质的关联图（\@ref(sec:assocplot)小节）和四瓣图（\@ref(sec:fourfoldplot)小节），前者可以让我们清楚看到如果列联表的行列变量不独立，那么哪些单元格对这个“不独立”的结论贡献大；后者可以让我们很快读出列联表的行列变量是否独立，即扇形环是否有重叠部分。

### 连续数据

相比之下连续数据的表达方式则要宽广得多：一维情况下，我们可以用直方图和密度曲线展示数据的概率分布，用箱线图以刻画四分位数的方式展示数据的概要（这是粗略的分布表达方式），用Cleveland点图表达原始数值的大小，或者用一维散点图同时表达原始数值及其粗略的分布；二维情况下最常用的是散点图，通常用来表达两个连续变量之间的线性或非线性关系，而散点图又常常和其它图形元素结合使用，例如回归直线等；三维情况下我们可以画三维的散点图，后面\@ref(subsec:music)小节有示例，对于特殊的三维数据我们还可以画三元图（\@ref(subsec:ternary)小节）；更高维情况下，我们有以下选择：

寻找载体
: 在二维平面上寻找其它维度的“载体”，这些“载体”有很多可能性，但都是用图形元素的某些属性来附着高维数据，例如符号图中的符号长宽高等（\@ref(sec:symbols)小节）、脸谱图中的脸部特征（\@ref(sec:faces)小节）

更改坐标系
: 笛卡尔坐标系理论上只能放二维变量，因此使用其它坐标系也是扩展到高维的自然选择，例如星状图使用的是星状的坐标系，从中心向外的每个分支都是一个坐标（\@ref(sec:stars)小节）；平行坐标图也是常见的表达高维数据的工具，它将垂直的坐标系改为平行的，而平面上理论上可以容纳无穷多根平行线，所以平行坐标图理论上也可以放置任意多的变量（\@ref(sec:parcoords)小节）

重复二维图形
: 二维的重复也可以达到表达高维数据的目的，例如散点图矩阵就是对所有变量两两重复画散点图，这样所有变量组合的散点图都可以表达在平面上了（\@ref(sec:scatterplot-matrix)小节）

降维
: 把高维数据降为二维数据也不失为一种办法，例如对数据做主成分分析，然后仅仅画前两个成分的散点图；实际上GGobi系统的巡游模式也是一种降维（\@ref(sec:dynamic-graphics)小节）

### 混合数据

```{r discrete-var,fig.cap="(ref:categorical-display)",fig.scap="分类变量的散点图示方法示例"}
par(
  mfrow = c(2, 2), mar = c(2.5, 3, 2, 0.1), pch = 20,
  mgp = c(1.5, 0.5, 0), cex.main = 1
)
x <- sample(rep(1:2, c(12, 18)))
y <- rep(1:2, c(18, 12))
plot(x, y,
  main = "(1) 原始散点图", xlim = c(0.8, 2.2),
  ylim = c(0.8, 2.2)
)
plot(jitter(x), jitter(y), main = "(2) 随机打散后的散点图")
points(x, y, cex = 3)
sunflowerplot(x, y,
  main = "(3) 向日葵散点图",
  xlim = c(0.8, 2.2), ylim = c(0.8, 2.2)
)
mosaicplot(table(x, y), main = "(4) 马塞克图")
```

(ref:categorical-display) 分类变量的散点图示方法示例：原始散点图、打散方法、向日葵散点图和马赛克图。

专门针对混合数据的图形并不多，前面介绍过的条件密度图（\@ref(sec:cdplot)小节）和棘状图（\@ref(sec:spineplot)小节）是两个少见的例子。在绝大多数情况下，我们都推荐使用“条件分割”的办法，利用分类变量的各个取值水平分别画二维图形，这样让我们很容易比较分类变量不同取值水平下的二维变量之间关系的差别。基础图形系统中的条件分割图（\@ref(sec:coplot)小节）只是一个引子，ggplot2包中的切片功能更灵活易用，后面图\@ref(fig:cn-us-redraw)便是一例。

一定程度上，这种针对数据类型总结图形类型的做法有些死板，例如两个分类变量一般情况下是无法画散点图的，因为分类变量只取有限的几个值，所以两个分类变量之间的散点图通常只是若干个网格点，而这些点本身并不能反映出该位置上真正的频数。我们在第\@ref(cha:gallery)章中提到过一些分类变量的图示方法，包括关联图（\@ref(sec:assocplot)节）、四瓣图（\@ref(sec:fourfoldplot)节）和马赛克图（\@ref(sec:mosaicplot)节）等，不过它们都不是最直接的散点图，而是将频数表达在其它图形元素中。那么分类变量是否一定不能画散点图呢？当然不是，向日葵散点图和随机打散的散点图就是两种可能。

关于向日葵散点图，在\@ref(sec:sunflowerplot)小节中已经有详细介绍，这里我们再次强调一下它在展示分类变量散点图上的功效。如\@ref(sec:sunflowerplot)小节中讲到的，向日葵散点图用向日葵的花瓣表示该处有多少个重复的数据点，而分类变量的散点图大多数情况下都会有重叠的数据点，因此分类变量尤其适合用向日葵散点图来表示。图\@ref(fig:discrete-var)(3)给出了一个用向日葵散点图表示分类变量的示例。

由于分类变量散点图的关键问题是重叠问题，因此我们不妨将重叠的数据稍微“打散”一些，然后再作散点图。关于打散方法，我们曾经在\@ref(sec:stripchart)小节中用到过，即`jitter()`函数。注意打散过的散点图不能严格按照点的坐标来解读，而是应该按聚集在一处的点的数目来解读频数。图\@ref(fig:discrete-var)(2)给出了一个打散之后的分类变量散点图示例。当然，最自然的选择可能还是马赛克图。我们画图不必墨守陈规，按照需要去考虑应该使用的图形类型即可。

## 数据案例

本节中我们通过一些数据实例来说明统计图形的创建过程，以及应用中可能存在的问题。首先我们看一个最简单的数据：猪肉价格。

### 价格走势

最近几年我们都比较关心物价问题，民间也有不少描述物价上涨的方式，比如作者曾经在邮件中收到一幅“猪肉价格走势图”如图\@ref(fig:pork-price-orig)，这幅图非常生动有趣，但莞尔之余我们不妨细看一下这幅图的横坐标 — 前四根柱子的对应的单位是一年，而后面五根柱子的单位却变成了三个月。虽然图中的小猪作腾飞状，但这幅图本身似乎看不出那么夸张的上涨效果。如果我们按照真实的横坐标单位来重画这幅图，则会看到另一番景象。因为这批数据很简单，我们可以手工录入到R：

```{r pork-data}
year <- c(2006, 2007, 2008, 2009, 2010 + c(1, 4, 7, 10, 13) / 12)
price <- c(12.11, 18.8, 22.09, 18.39, 19.86, 14.89, 16.68, 18.76, 19.57)
```

这是一个一维时间序列数据，对于时间序列，我们通常会采用折线图来表达数据的波动起伏，观察的核心是数据的大小随着时间的变化，但原图使用条形图实际上也有一定道理。这批数据一共只有9个数字，如果只是用折线画图，则整幅图形显得单薄，加上该图的装饰物太多，所以更容易埋没数据。相比之下，矩形条的视觉冲击力较强，更能让读者的注意力集中在数据上。本例中，选取折线图或是条形图取决于具体的应用场景。

```{r pork-price-orig,fig.cap="自2006年以来猪肉价格的走势图",echo=FALSE}
knitr::include_graphics(path = "images/pork-price-orig.pdf")
```

图\@ref(fig:pork-price)同时给出了两种图形。横坐标被调整到正确的位置上之后，我们可以看出2010年的价格上涨真的如原图中的小猪一样直飞而上。道理很简单，原本三个月的上涨如果被“稀释”到一年中，那么我们当然不会感觉到强烈的上升趋势。图\@ref(fig:pork-price)给我们另外一点启示是，条形图容易观察差异大小（比较条的长短），而折线图更容易观察斜率大小（升降速度）。

当我们用R重画出图形的时候，我们意识到纵坐标可能也存在问题：原图的纵坐标的零点对应的价格是多少？可以肯定并不是0，这一点通过简单地选取参照物就能判断出来，例如06和07年的差价大约是6.7，两年价格条高度之差和2010年4月的价格条高度差不多，这说明零点可能在8元/千克左右。这个零点选择似乎非常随意，通常我们画图会以真实的0为零点，或者以数据的最小值为零点，很少选取其它位置为零点。关于零点的选取，我们在\@ref(subsec:data-processing)小节中会继续解释。这里我们简要说明一下：如果将零点选在真实的0上，那么我们更容易计算真实的比率（高度之比）；若选在最小值上，那么更容易看出绝对变化值（因为差异被“放大”了）。

```{r pork-price,fig.scap="更新后的猪肉价格走势图",fig.cap="(ref:pork-price)"}
par(mfrow = c(2, 2))
plot(year, price, type = "h", lwd = 5, lend = 1, ylim = c(0, max(price) + 1), yaxs = "i")
plot(year, price, type = "h", lwd = 5, lend = 1)
plot(year, price, type = "o", ylim = c(0, max(price) + 1), yaxs = "i")
plot(year, price, type = "o")
```

(ref:pork-price) 更新后的猪肉价格走势图：上方为条形图，下方为折线图，左侧图形的y轴从0开始，右侧图形的y轴从数据的最小值开始。

### 末日狂奔 {#subsec:canabalt}

```{r canabalt-screenshot,echo=FALSE,fig.scap="末日狂奔游戏截图",fig.cap="(ref:canabalt-screenshot)"}
knitr::include_graphics(path = "images/canabalt-screenshot.png")
```

(ref:canabalt-screenshot) 末日狂奔游戏截图：楼顶左侧的小人为游戏主角，任务为尽力向前跑，一路上可能遇到很多障碍和意外；右上角为奔跑的距离（483米）。

末日狂奔（Canabalt）是一款速度躲避游戏，操控很简单，点击屏幕控制主角跳起，控制好跳跃力度尽量避开一路上的障碍，不要掉下楼，看最后能跑多远。这款游戏的简单与刺激吸引了很多玩家；此外游戏中还有一定的随机成分，玩家无法预测下一步的场景是什么。由于游戏结束时画面上会提示是否把奔跑的距离发到Twitter上，所以Twitter上有不少关于这个游戏的得分消息，我们可以抓取这些消息来看各位玩家跑了多远以及玩游戏的平台信息。

MSG包中的数据集canabalt收录了1208条这样的数据，数据包括3列：得分、死因和游戏平台（iPad、iPhone和iPod touch）。

```{r canabalt-data}
data(canabalt)
summary(canabalt)
```

我们关心的重点当然是得分，因此拿到这批数据我们可以先看一下得分的分布，例如用直方图；其次我们会考虑游戏得分和平台是否有关，高分玩家会因为什么原因死亡，等等，这都是基于离散变量的连续变量比较，一个自然而然的选择就是对离散变量的每一分类分别画图。图\@ref(fig:canabalt-boxplot)是基于离散变量的不同分类的箱线图，从图中可以看出，iPad玩家的平均得分较高，这可能是因为iPad相比起iPhone或者iPod touch来说屏幕较大，玩家易于控制，也可能是因为iPad需要专门开机，不像另外两个平台随时都能打开玩，因此iPad玩家玩起来会更集中精力。至于死因，由于作者对这款游戏并不在行，玩了几次，得到的结果都是因为跳得不够高而撞墙坠落摔死，最多能跑几百米，因此不了解其它死因的场景。因为撞墙摔死的玩家中有很多人得分超高，看来这种障碍的难度并不小。注意我们画箱线图时，对死因做了重新排序 — 按照得分的中位数排序，这样能方便读者阅读这幅图，否则，读者需要额外花费功夫用眼睛对箱线图排序，对读者来说是不必要的阅读负担。按照原始数据的顺序画图尤其是条形图和饼图中常见的问题，其实排序对于制图者只是举手之劳，对读者却能带来很大的方便。

```{r canabalt-boxplot,fig.cap="(ref:canabalt-boxplot)",fig.scap="游戏得分在不同游戏平台以及死因下的比较"}
print(qplot(device, score, data = canabalt, geom = "boxplot") +
  coord_flip())
print(qplot(reorder(death, score, median), score,
  data = canabalt,
  geom = "boxplot", xlab = "death"
) +
  coord_flip())
```

(ref:canabalt-boxplot) 游戏得分在不同游戏平台以及死因下的比较：iPad玩家的分数平均较高，得分最高的人最终是因为“错过另一扇窗”而死。

在canabalt数据的帮助文档中有这批数据的来源以及收集方式，对抓取网络数据感兴趣的读者不妨看看原作者是如何用Python等工具获得数据的。

### 音乐之声 {#subsec:music}

Cook and Swayne (2007)中使用了一个关于音乐曲目的数据，它整理了一些曲目的前40秒的音频统计量，这批数据也被收录在MSG包中，名为music。数据包含36个曲目，其中有古典音乐如莫扎特和维瓦尔第的作品，也有摇滚乐如Abba和Eels乐队的曲目。这里除了曲目类型（古典或摇滚）之外，我们仅仅使用三个连续变量：左声道频率的均值、最大值和方差。

```{r music-data}
data(music)
head(music[, 1:5]) # 头6行数据
summary(music[, 1:5])
```

```{r music-andrews,fig.scap="音乐曲目左声道频率的调和曲线图",fig.cap="(ref:music-andrews)"}
par(mfrow = c(1, 2))
andrews_curve(scale(music[, 4:6]), n = 50, col = 1)
with(
  music,
  andrews_curve(scale(music[, 4:6]),
    n = 50,
    col = artist, lty = as.integer(type)
  )
)
```

(ref:music-andrews) 音乐曲目左声道频率的调和曲线图：左图中曲线是否有“拧成股”的现象？右图是否是你真实感受到的聚类？

对这样一批数据，我们关心的问题可能是古典乐和摇滚乐在音频变量上是否有差异。由于这里的变量个数是3，所以我们可以考虑三维散点图，并用不同颜色标注曲目类型。在真正使用曲目类型这个变量之前，我们不妨对数据做一个简单的探索：试想如果我们并不知道曲目的分类，我们是否能从某些图中看出数据有聚类现象？考虑到古典乐和摇滚乐的区别，以及艺术家风格的不同，这种聚类现象应该是很自然的。对于三个连续变量，我们的选择余地并不大：\@ref(sec:andrews-curve)小节介绍的调和曲线图可以作为探索聚类的工具。图\@ref(fig:music-andrews)为三个变量的调和曲线图，为了不把预期中的聚类现象强加于我们脑中，首先我们不使用任何方式标注分类信息，统一用黑色，如左图所示，这些曲线的走势是否有扎堆现象？这里我们不想故意引导读者，请读者自行观察。某种程度上，标记和不标记分类变量会对一幅图形产生很大的影响，比如即使一幅图中本来没有聚类现象，但由于我们使用了颜色或其它手段将图形元素分了组，这时我们的眼睛很容易引导我们认为图中存在聚类。看完左图之后再看右图，你的结论有变化吗？右图中虚线表示摇滚，实线表示古典；红色为Eels，黑色为Abba，蓝色为维瓦尔第，绿色为莫扎特。从“事后诸葛亮”的角度来说，这些曲目似乎确实存在差异。

```{r music-3d-pcp,fig.cap="(ref:music-3d-pcp)",fig.scap="音乐曲目左声道频率的三维散点图与平行坐标图",message=FALSE,fig.subcap=c("","")}
library(scatterplot3d)
with(
  music,
  scatterplot3d(lave, lmax, lvar / 1e6,
    pch = 19,
    color = as.integer(type), mar = c(2.5, 3, .1, 2)
  )
)
library(GGally)
ggparcoord(music, columns = c(4, 5, 3), groupColumn = "type")
```

(ref:music-3d-pcp) 音乐曲目左声道频率的三维散点图（上）与平行坐标图（下）：三维散点图中我们难以感知点的位置，平行坐标图则更易读。

调和曲线图展示的并非原始数据，所以即使我们知道有差异，也无法知道差异具体是什么样的。图\@ref(fig:music-3d-pcp)上图为三维散点图，用颜色区分了古典乐和摇滚乐；下图为三个变量的平行坐标图。三维散点图往往被人们视为很能吸引眼球的图形，但本作者倾向于反对使用它，原因是多数情况下我们看到的三维图形都是静态的，不可旋转，而三维图形的外观非常依赖于我们观察它的视角，正所谓“横看成岭侧成峰，远近高低各不同”，这给读图带来了视觉上的限制，此外，三维图形也需要空间想象力，例如我们是否能看清图中每个点在纵轴上的高度？观察三维图形中的数值需要用眼睛对三个垂直的平面做投影，这是一件非常费力的工作。这里顺便提一下，Excel中可以画三维条形图/柱形图甚至饼图，这些图形通常都是非常糟糕的选择。Krause (2009)是一篇关于三维条形图的短小评论，感兴趣的读者不妨一读。

尽管三维散点图有种种劣势，但在本例中有一点可以肯定，那就是古典乐和摇滚乐在频率上是有差异的，因为我们可以看到图中的散点并没有混杂在一起，而是有着较好的分隔（请再考虑一下这是否是“事后诸葛亮”的结论）。为了看清具体的数值上的差异，我们可以使用平行坐标图如\@ref(fig:music-3d-pcp)下图。古典乐左声道的频率均值相对较高，但最大值相对较低，而且方差非常小，这说明古典乐的演奏频率相对固定在较高的水平上；而摇滚乐的平均频率相对较低，但最大值和方差都很大，这说明摇滚乐的频率波动幅度较大，高方差也可能是因为最大值太大引起的，这似乎让我们不由联想到嘶吼的摇滚歌手，读者若有兴趣，可以用tuneR包(Ligges, 2010)读入信乐团的《离歌》做分析，看是否能看到“低均值高方差”的特征。
